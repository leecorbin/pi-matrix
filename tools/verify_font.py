#!/usr/bin/env python3
"""
ZX Spectrum Font Verification Tool
Compares current font.py against authentic ZX Spectrum ROM font data
"""

# Authentic ZX Spectrum ROM font data (addresses 0x3D00-0x3FFF)
# Each character is 8 bytes, one byte per row, MSB = left pixel
AUTHENTIC_ZX_FONT = {
    # Space (0x20)
    ' ': [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
    
    # Punctuation (0x21-0x2F)
    '!': [0x00, 0x10, 0x10, 0x10, 0x10, 0x00, 0x10, 0x00],
    '"': [0x00, 0x24, 0x24, 0x00, 0x00, 0x00, 0x00, 0x00],
    '#': [0x00, 0x24, 0x7E, 0x24, 0x24, 0x7E, 0x24, 0x00],
    '$': [0x00, 0x08, 0x3E, 0x28, 0x3E, 0x0A, 0x3E, 0x08],
    '%': [0x00, 0x62, 0x64, 0x08, 0x10, 0x26, 0x46, 0x00],
    '&': [0x00, 0x10, 0x28, 0x10, 0x2A, 0x44, 0x3A, 0x00],
    "'": [0x00, 0x08, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00],
    '(': [0x00, 0x04, 0x08, 0x08, 0x08, 0x08, 0x04, 0x00],
    ')': [0x00, 0x20, 0x10, 0x10, 0x10, 0x10, 0x20, 0x00],
    '*': [0x00, 0x00, 0x14, 0x08, 0x3E, 0x08, 0x14, 0x00],
    '+': [0x00, 0x00, 0x08, 0x08, 0x3E, 0x08, 0x08, 0x00],
    ',': [0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x08, 0x10],
    '-': [0x00, 0x00, 0x00, 0x00, 0x3E, 0x00, 0x00, 0x00],
    '.': [0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00],
    '/': [0x00, 0x00, 0x02, 0x04, 0x08, 0x10, 0x20, 0x00],
    
    # Digits (0x30-0x39)
    '0': [0x00, 0x3C, 0x46, 0x4A, 0x52, 0x62, 0x3C, 0x00],
    '1': [0x00, 0x18, 0x28, 0x08, 0x08, 0x08, 0x3E, 0x00],
    '2': [0x00, 0x3C, 0x42, 0x02, 0x3C, 0x40, 0x7E, 0x00],
    '3': [0x00, 0x3C, 0x42, 0x0C, 0x02, 0x42, 0x3C, 0x00],
    '4': [0x00, 0x08, 0x18, 0x28, 0x48, 0x7E, 0x08, 0x00],
    '5': [0x00, 0x7E, 0x40, 0x7C, 0x02, 0x42, 0x3C, 0x00],
    '6': [0x00, 0x3C, 0x40, 0x7C, 0x42, 0x42, 0x3C, 0x00],
    '7': [0x00, 0x7E, 0x02, 0x04, 0x08, 0x10, 0x10, 0x00],
    '8': [0x00, 0x3C, 0x42, 0x3C, 0x42, 0x42, 0x3C, 0x00],
    '9': [0x00, 0x3C, 0x42, 0x42, 0x3E, 0x02, 0x3C, 0x00],
    
    # More punctuation (0x3A-0x40)
    ':': [0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x10, 0x00],
    ';': [0x00, 0x00, 0x10, 0x00, 0x00, 0x10, 0x10, 0x20],
    '<': [0x00, 0x00, 0x04, 0x08, 0x10, 0x08, 0x04, 0x00],
    '=': [0x00, 0x00, 0x00, 0x3E, 0x00, 0x3E, 0x00, 0x00],
    '>': [0x00, 0x00, 0x10, 0x08, 0x04, 0x08, 0x10, 0x00],
    '?': [0x00, 0x3C, 0x42, 0x04, 0x08, 0x00, 0x08, 0x00],
    '@': [0x00, 0x3C, 0x4A, 0x56, 0x5E, 0x40, 0x3C, 0x00],
    
    # Uppercase (0x41-0x5A)
    'A': [0x00, 0x18, 0x24, 0x42, 0x42, 0x7E, 0x42, 0x00],
    'B': [0x00, 0x7C, 0x42, 0x7C, 0x42, 0x42, 0x7C, 0x00],
    'C': [0x00, 0x3C, 0x42, 0x40, 0x40, 0x42, 0x3C, 0x00],
    'D': [0x00, 0x78, 0x44, 0x42, 0x42, 0x44, 0x78, 0x00],
    'E': [0x00, 0x7E, 0x40, 0x7C, 0x40, 0x40, 0x7E, 0x00],
    'F': [0x00, 0x7E, 0x40, 0x7C, 0x40, 0x40, 0x40, 0x00],
    'G': [0x00, 0x3C, 0x42, 0x40, 0x4E, 0x42, 0x3C, 0x00],
    'H': [0x00, 0x42, 0x42, 0x7E, 0x42, 0x42, 0x42, 0x00],
    'I': [0x00, 0x3E, 0x08, 0x08, 0x08, 0x08, 0x3E, 0x00],
    'J': [0x00, 0x02, 0x02, 0x02, 0x42, 0x42, 0x3C, 0x00],
    'K': [0x00, 0x44, 0x48, 0x70, 0x48, 0x44, 0x42, 0x00],
    'L': [0x00, 0x40, 0x40, 0x40, 0x40, 0x40, 0x7E, 0x00],
    'M': [0x00, 0x42, 0x66, 0x5A, 0x42, 0x42, 0x42, 0x00],
    'N': [0x00, 0x42, 0x62, 0x52, 0x4A, 0x46, 0x42, 0x00],
    'O': [0x00, 0x3C, 0x42, 0x42, 0x42, 0x42, 0x3C, 0x00],
    'P': [0x00, 0x7C, 0x42, 0x42, 0x7C, 0x40, 0x40, 0x00],
    'Q': [0x00, 0x3C, 0x42, 0x42, 0x52, 0x4A, 0x3C, 0x00],
    'R': [0x00, 0x7C, 0x42, 0x42, 0x7C, 0x44, 0x42, 0x00],
    'S': [0x00, 0x3C, 0x40, 0x3C, 0x02, 0x42, 0x3C, 0x00],
    'T': [0x00, 0xFE, 0x10, 0x10, 0x10, 0x10, 0x10, 0x00],
    'U': [0x00, 0x42, 0x42, 0x42, 0x42, 0x42, 0x3C, 0x00],
    'V': [0x00, 0x42, 0x42, 0x42, 0x42, 0x24, 0x18, 0x00],
    'W': [0x00, 0x42, 0x42, 0x42, 0x42, 0x5A, 0x24, 0x00],
    'X': [0x00, 0x42, 0x24, 0x18, 0x18, 0x24, 0x42, 0x00],
    'Y': [0x00, 0x82, 0x44, 0x28, 0x10, 0x10, 0x10, 0x00],
    'Z': [0x00, 0x7E, 0x04, 0x08, 0x10, 0x20, 0x7E, 0x00],
    
    # Brackets (0x5B-0x60)
    '[': [0x00, 0x0E, 0x08, 0x08, 0x08, 0x08, 0x0E, 0x00],
    '\\': [0x00, 0x00, 0x40, 0x20, 0x10, 0x08, 0x04, 0x00],
    ']': [0x00, 0x70, 0x10, 0x10, 0x10, 0x10, 0x70, 0x00],
    '^': [0x00, 0x10, 0x38, 0x54, 0x10, 0x10, 0x10, 0x00],  # UP ARROW (↑)
    '_': [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF],
    '`': [0x00, 0x1C, 0x22, 0x78, 0x20, 0x20, 0x7E, 0x00],  # POUND SIGN (£) at 0x60
    
    # Lowercase (0x61-0x7A)
    'a': [0x00, 0x00, 0x38, 0x04, 0x3C, 0x44, 0x3C, 0x00],
    'b': [0x00, 0x20, 0x20, 0x3C, 0x22, 0x22, 0x3C, 0x00],
    'c': [0x00, 0x00, 0x1C, 0x20, 0x20, 0x20, 0x1C, 0x00],
    'd': [0x00, 0x04, 0x04, 0x3C, 0x44, 0x44, 0x3C, 0x00],
    'e': [0x00, 0x00, 0x38, 0x44, 0x78, 0x40, 0x3C, 0x00],
    'f': [0x00, 0x0C, 0x10, 0x18, 0x10, 0x10, 0x10, 0x00],
    'g': [0x00, 0x00, 0x3C, 0x44, 0x44, 0x3C, 0x04, 0x38],
    'h': [0x00, 0x40, 0x40, 0x78, 0x44, 0x44, 0x44, 0x00],
    'i': [0x00, 0x10, 0x00, 0x30, 0x10, 0x10, 0x38, 0x00],
    'j': [0x00, 0x04, 0x00, 0x04, 0x04, 0x04, 0x24, 0x18],
    'k': [0x00, 0x20, 0x28, 0x30, 0x30, 0x28, 0x24, 0x00],
    'l': [0x00, 0x10, 0x10, 0x10, 0x10, 0x10, 0x0C, 0x00],
    'm': [0x00, 0x00, 0x68, 0x54, 0x54, 0x54, 0x54, 0x00],
    'n': [0x00, 0x00, 0x78, 0x44, 0x44, 0x44, 0x44, 0x00],
    'o': [0x00, 0x00, 0x38, 0x44, 0x44, 0x44, 0x38, 0x00],
    'p': [0x00, 0x00, 0x78, 0x44, 0x44, 0x78, 0x40, 0x40],
    'q': [0x00, 0x00, 0x3C, 0x44, 0x44, 0x3C, 0x04, 0x06],
    'r': [0x00, 0x00, 0x1C, 0x20, 0x20, 0x20, 0x20, 0x00],
    's': [0x00, 0x00, 0x38, 0x40, 0x38, 0x04, 0x78, 0x00],
    't': [0x00, 0x10, 0x38, 0x10, 0x10, 0x10, 0x0C, 0x00],
    'u': [0x00, 0x00, 0x44, 0x44, 0x44, 0x44, 0x38, 0x00],
    'v': [0x00, 0x00, 0x44, 0x44, 0x28, 0x28, 0x10, 0x00],
    'w': [0x00, 0x00, 0x44, 0x54, 0x54, 0x54, 0x28, 0x00],
    'x': [0x00, 0x00, 0x44, 0x28, 0x10, 0x28, 0x44, 0x00],
    'y': [0x00, 0x00, 0x44, 0x44, 0x44, 0x3C, 0x04, 0x38],
    'z': [0x00, 0x00, 0x7C, 0x08, 0x10, 0x20, 0x7C, 0x00],
    
    # Final symbols (0x7B-0x7F)
    '{': [0x00, 0x0E, 0x08, 0x30, 0x08, 0x08, 0x0E, 0x00],
    '|': [0x00, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x00],
    '}': [0x00, 0x70, 0x10, 0x0C, 0x10, 0x10, 0x70, 0x00],
    '~': [0x00, 0x14, 0x28, 0x00, 0x00, 0x00, 0x00, 0x00],
    '\x7f': [0x0F, 0x09, 0x0F, 0x09, 0x0F, 0x09, 0x09, 0x00],  # COPYRIGHT (©) at 0x7F
}


def compare_fonts():
    """Compare our font against authentic ZX Spectrum ROM"""
    import sys
    import os
    sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..'))
    
    from matrixos.font import Font
    
    font = Font()
    
    print("=" * 80)
    print("ZX SPECTRUM FONT VERIFICATION")
    print("=" * 80)
    print()
    
    differences = []
    missing = []
    
    for char, authentic_bitmap in AUTHENTIC_ZX_FONT.items():
        our_bitmap = font.get_char_bitmap(char)
        
        if our_bitmap is None:
            missing.append(char)
            continue
        
        if our_bitmap != authentic_bitmap:
            differences.append((char, authentic_bitmap, our_bitmap))
    
    # Check character code mapping
    print("CHARACTER CODE MAPPING:")
    print("-" * 80)
    print(f"  ASCII 0x5E (^): Should be UP ARROW (↑)")
    print(f"  ASCII 0x60 (`): Should be POUND SIGN (£)")
    print(f"  ASCII 0x7F (DEL): Should be COPYRIGHT (©)")
    print()
    
    if not differences and not missing:
        print("✓ PERFECT! Font is 100% pixel-perfect match to ZX Spectrum ROM")
        print()
        return 0
    
    if missing:
        print(f"⚠ MISSING CHARACTERS: {len(missing)}")
        for char in missing:
            print(f"  Missing: {repr(char)} (0x{ord(char):02X})")
        print()
    
    if differences:
        print(f"⚠ DIFFERENCES FOUND: {len(differences)} characters differ")
        print()
        
        for char, authentic, ours in differences:
            print(f"Character: {repr(char)} (ASCII 0x{ord(char):02X})")
            print("  Authentic ZX ROM   |  Our Implementation")
            print("  -------------------+-------------------")
            for row in range(8):
                auth_byte = authentic[row] if row < len(authentic) else 0x00
                our_byte = ours[row] if row < len(ours) else 0x00
                
                # Visual representation
                auth_visual = ''.join('█' if auth_byte & (0x80 >> i) else '·' for i in range(8))
                our_visual = ''.join('█' if our_byte & (0x80 >> i) else '·' for i in range(8))
                
                diff_marker = " " if auth_byte == our_byte else " ← DIFF"
                print(f"  {auth_visual} 0x{auth_byte:02X} | {our_visual} 0x{our_byte:02X}{diff_marker}")
            
            print()
    
    print("=" * 80)
    print(f"SUMMARY: {len(differences)} differences, {len(missing)} missing")
    print("=" * 80)
    
    return 1 if (differences or missing) else 0


if __name__ == '__main__':
    exit(compare_fonts())
